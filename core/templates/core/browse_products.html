{% extends 'core/dashboard_base.html' %} {% load static %} {% block content %}

<!-- Cart Modal -->
<div
  class="modal fade"
  id="cartModal"
  tabindex="-1"
  aria-labelledby="cartModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">
          <i class="fas fa-shopping-cart me-2"></i>Your Cart
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="cart-items">
          <!-- Cart items will be dynamically inserted here -->
        </div>
        <div class="cart-total text-end mt-4">
          <h5>Total: $<span id="cartTotal">0.00</span></h5>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Continue Shopping
        </button>
        <button type="button" class="btn btn-success" id="submitOrder">
          Submit Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Floating Cart Icon -->
<div class="cart-floating" data-bs-toggle="modal" data-bs-target="#cartModal">
  <i class="fas fa-shopping-cart"></i>
  <span class="cart-count">0</span>
</div>

<div class="dashboard-header">
  <h1 class="dashboard-title">
    Fresh Market <i class="fas fa-shopping-basket"></i>
  </h1>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="filter-group">
        <i class="fas fa-filter filter-icon"></i>
        <select class="form-select" id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Vegetables">ü•¶ Vegetables</option>
          <option value="Fruits">üçé Fruits</option>
          <option value="Grains">üåæ Grains</option>
          <option value="Dairy">ü•õ Dairy</option>
        </select>
      </div>
    </div>
    <div class="col-md-8">
      <div class="search-group">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          class="form-control"
          id="searchInput"
          placeholder="Find fresh produce..."
        />
      </div>
    </div>
  </div>
</div>

<div class="dashboard-grid">
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="productList">
    {% for product in products %}
    <div
      class="col product-card-container"
      data-name="{{ product.name|lower }}"
      data-category="{{ product.category }}"
    >
      <div class="product-card">
        <div class="product-image-wrapper">
          <img
            src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.png' %}{% endif %}"
            class="product-image"
            alt="{{ product.name }}"
          />
          <div class="category-badge">{{ product.category }}</div>
        </div>
        <div class="card-body">
          <div class="product-header">
            <h3 class="product-title">{{ product.name }}</h3>
            <div class="product-price">${{ product.price_per_kg }}/kg</div>
          </div>
          <p class="product-description">
            {{ product.description|truncatechars:100 }}
          </p>
          <div class="farmer-info">
            <div class="farmer-avatar">
              {% if product.farmer.profile.image %}
              <img
                src="{{ product.farmer.profile.image.url }}"
                alt="{{ product.farmer.username }}"
              />
              {% else %}
              <div class="default-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              {% endif %}
            </div>
            <div class="farmer-details">
              <div class="farmer-name">{{ product.farmer.username }}</div>
              <div class="farmer-location">
                <i class="fas fa-map-marker-alt"></i>
                <span>Nyeri County</span>
              </div>
            </div>
          </div>
          <button
            class="btn btn-add-to-cart"
            data-product-id="{{ product.id }}"
          >
            <i class="fas fa-cart-plus"></i> Add to Cart
          </button>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <i class="fas fa-seedling"></i>
      <h4>No products available</h4>
      <p>Check back later for fresh updates!</p>
    </div>
    {% endfor %}
  </div>

  {% if products.has_other_pages %}
  <nav class="mt-4">
    <ul class="pagination">
      {% if products.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ products.previous_page_number }}">
          <i class="fas fa-chevron-left"></i>
        </a>
      </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link">
          Page {{ products.number }} of {{ products.paginator.num_pages }}
        </span>
      </li>

      {% if products.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ products.next_page_number }}">
          <i class="fas fa-chevron-right"></i>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let cart = [];
    const cartCount = document.querySelector(".cart-count");
    const cartItemsContainer = document.querySelector(".cart-items");
    const cartTotal = document.querySelector("#cartTotal");

    // Add to Cart Functionality
    document.querySelectorAll(".btn-add-to-cart").forEach((button) => {
      button.addEventListener("click", function () {
        const productCard = this.closest(".product-card");
        const product = {
          id: this.dataset.productId,
          name: productCard.querySelector(".product-title").innerText,
          price: parseFloat(
            productCard
              .querySelector(".product-price")
              .innerText.replace("$", "")
              .replace("/kg", "")
          ),
          image: productCard.querySelector("img").src,
        };

        // Add to cart array
        const existingItem = cart.find((item) => item.id === product.id);
        if (existingItem) {
          existingItem.quantity++;
        } else {
          product.quantity = 1;
          cart.push(product);
        }

        updateCartDisplay();
        showCartAlert(product);
      });
    });

    // Update Cart Display
    function updateCartDisplay() {
      // Update cart count
      cartCount.textContent = cart.reduce(
        (sum, item) => sum + item.quantity,
        0
      );

      // Update cart items
      cartItemsContainer.innerHTML = cart
        .map(
          (item) => `
            <div class="cart-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="cart-item-info">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${item.name}</h6>
                        <button class="btn btn-remove" data-product-id="${
                          item.id
                        }">
                            <i class="fas fa-times text-danger"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="quantity-controls">
                            <button class="btn btn-sm btn-quantity minus" data-product-id="${
                              item.id
                            }">-</button>
                            <input type="number" min="1" value="${
                              item.quantity
                            }" 
                                   class="quantity-input" data-product-id="${
                                     item.id
                                   }">
                            <button class="btn btn-sm btn-quantity plus" data-product-id="${
                              item.id
                            }">+</button>
                        </div>
                        <div>
                            <span class="cart-item-price">$${(
                              item.price * item.quantity
                            ).toFixed(2)}</span>
                            <small class="text-muted">($${item.price.toFixed(
                              2
                            )}/kg)</small>
                        </div>
                    </div>
                </div>
            </div>
        `
        )
        .join("");

      // Add quantity control event listeners
      document.querySelectorAll(".btn-quantity").forEach((button) => {
        button.addEventListener("click", function () {
          const productId = this.dataset.productId;
          const item = cart.find((item) => item.id === productId);
          if (this.classList.contains("plus")) {
            item.quantity++;
          } else {
            item.quantity = Math.max(1, item.quantity - 1);
          }
          updateCartDisplay();
        });
      });

      document.querySelectorAll(".quantity-input").forEach((input) => {
        input.addEventListener("change", function () {
          const productId = this.dataset.productId;
          const item = cart.find((item) => item.id === productId);
          const newQuantity = parseInt(this.value) || 1;
          item.quantity = Math.max(1, newQuantity);
          updateCartDisplay();
        });
      });

      // Add remove item functionality
      document.querySelectorAll(".btn-remove").forEach((button) => {
        button.addEventListener("click", function () {
          const productId = this.dataset.productId;
          cart = cart.filter((item) => item.id !== productId);
          updateCartDisplay();
        });
      });

      // Update total
      const total = cart.reduce(
        (sum, item) => sum + item.price * item.quantity,
        0
      );
      cartTotal.textContent = total.toFixed(2);
    }

    // Submit Order
    document
      .querySelector("#submitOrder")
      .addEventListener("click", function () {
        if (cart.length === 0) return;

        Swal.fire({
          title: "Confirm Order?",
          text: `Total amount: $${cartTotal.textContent}`,
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#198754",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Submit Order",
        }).then((result) => {
          if (result.isConfirmed) {
            // Here you would typically send the cart data to your backend
            Swal.fire({
              title: "Order Submitted!",
              text: "Your order has been successfully placed",
              icon: "success",
              confirmButtonColor: "#198754",
              timer: 2000,
            });
            cart = [];
            updateCartDisplay();
          }
        });
      });

    function showCartAlert(product) {
      Swal.fire({
        title: "Added to Cart!",
        html: `<strong>${product.name}</strong><br>$${product.price.toFixed(
          2
        )}/kg`,
        icon: "success",
        confirmButtonColor: "#198754",
        timer: 1500,
        timerProgressBar: true,
        showClass: { popup: "animate__animated animate__zoomIn" },
        hideClass: { popup: "animate__animated animate__zoomOut" },
      });
    }
  });
</script>
{% endblock %}
