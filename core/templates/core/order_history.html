{% extends 'core/dashboard_base.html' %} {% load static %} {% block content %}

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}

<!-- Add SweetAlert2 library -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Order History Page Header -->
<div class="dashboard-header">
  <div class="header-content">
    <h1 class="dashboard-title">
      Order History <i class="fas fa-history"></i>
    </h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'dashboard' %}">Dashboard</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          Order History
        </li>
      </ol>
    </nav>
  </div>
</div>

<!-- Order History Section -->
<div class="order-history-container">
  {% if orders %}
  <div class="order-grid">
    {% for order in orders %}
    <div class="order-card">
      <div class="order-meta">
        <div class="order-id">
          <h3>#{{ order.id }}</h3>
          <span class="order-status {{ order.status|lower }}">{{ order.status }}</span>
          {% if order.escrow %}
            {% if order.escrow.status == 'Disputed' %}
              <span class="payment-status disputed">Disputed</span>
            {% elif order.escrow.status == 'Refunded' %}
              <span class="payment-status refunded">Refunded</span>
            {% elif order.escrow.status == 'Released' %}
              <span class="payment-status released">Released</span>
            {% elif order.escrow.status == 'Waiting_Confirmation' %}
              <span class="payment-status waiting">Awaiting Release</span>
            {% elif order.escrow.status == 'Funded' %}
              <span class="payment-status in-escrow">In Escrow</span>
            {% elif order.escrow.status == 'Pending' %}
              <span class="payment-status pending">Pending</span>
            {% endif %}
          {% else %}
            <span class="payment-status {{ order.payment_status|lower }}">{{ order.payment_status }}</span>
          {% endif %}
        </div>
        <div class="order-dates">
          <div class="order-date">
            <i class="fas fa-calendar-alt"></i>
            {{ order.created_at|date:"M j, Y" }}
          </div>
        </div>
      </div>

      <div class="order-products">
        <div class="products-header">
          <h4>{{ order.product.name }}</h4>
          <span class="total-amount">${{ order.total_price }}</span>
        </div>

        <div class="product-grid">
          <div class="product-item">
            <img
              src="{% if order.product.image %}{{ order.product.image.url }}{% else %}{% static 'images/default-product.png' %}{% endif %}"
              alt="{{ order.product.name }}"
              class="product-image"
            />
            <div class="product-info">
              <div class="product-meta">
                <span class="quantity">Qty: {{ order.quantity }}kg</span>
                <span class="price">${{ order.product.price_per_kg }}/kg</span>
              </div>
              <div class="vendor-info">
                <i class="fas fa-user"></i>
                {{ order.product.farmer.username }}
              </div>
              <div class="product-location">
                <i class="fas fa-map-marker-alt"></i>
                {{ order.product.location }}
              </div>
              <div class="payment-info">
                <i class="fas fa-money-check-alt"></i>
                Payment Status: 
                {% if order.escrow %}
                  {% if order.escrow.status == 'Disputed' %}
                    <span class="payment-status disputed">Disputed</span>
                  {% elif order.escrow.status == 'Refunded' %}
                    <span class="payment-status refunded">Refunded</span>
                  {% elif order.escrow.status == 'Released' %}
                    <span class="payment-status released">Released</span>
                  {% elif order.escrow.status == 'Funded' %}
                    <span class="payment-status in-escrow">In Escrow</span>
                  {% elif order.escrow.status == 'Pending' %}
                    <span class="payment-status pending">Pending</span>
                  {% endif %}
                {% else %}
                  <span class="payment-status {{ order.payment_status|lower }}">{{ order.payment_status }}</span>
                {% endif %}
                {% if order.escrow and order.escrow.status == 'Released' %}
                <div class="payment-details">
                  <small><i class="fas fa-clock"></i> Released on: {{ order.escrow.release_date|date:"M j, Y" }}</small>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="order-actions">
        <button
          class="btn btn-details"
          data-order-id="{{ order.id }}"
          onclick="showOrderDetails({{ order.id }})"
        >
          <i class="fas fa-file-invoice"></i> Details
        </button>
        {% if order.escrow and order.escrow.status == 'Waiting_Confirmation' %}
        <div class="countdown-container">
          <div id="countdown-timer-{{ order.id }}" class="countdown-timer" data-release-time="{{ order.escrow.scheduled_release_time|date:'c' }}">
            <span class="countdown-label">Time to dispute:</span>
            <span class="countdown-value"></span>
          </div>
          <button
            class="btn btn-danger"
            onclick="showDisputeModal({{ order.id }})"
          >
            <i class="fas fa-exclamation-triangle"></i> Dispute Order
          </button>
        </div>
        {% endif %}
        {% if order.status == 'Completed' and order.escrow and order.escrow.status == 'Funded' %}
        <button
          class="btn btn-complete"
          onclick="confirmOrder({{ order.id }})"
        >
          <i class="fas fa-check-circle"></i> Complete Order
        </button>
        {% endif %}
        {% if order.escrow and order.escrow.status == 'Pending' %}
        <a
          href="{% url 'escrow_payment' order.id %}"
          class="btn btn-payment"
        >
          <i class="fas fa-credit-card"></i> Make Payment
        </a>
        {% endif %}
        {% if order.escrow and order.escrow.status == 'Released' %}
        <button
          class="btn btn-repeat"
          onclick="reorderProduct({{ order.id }}, {{ order.quantity }})"
        >
          <i class="fas fa-redo"></i> Re-order
        </button>
        {% endif %}
        {% if order.escrow and order.escrow.status == 'Disputed' %}
        <a
          href="{% url 'dispute_detail' order.id %}"
          class="btn btn-dispute"
        >
          <i class="fas fa-gavel"></i> View Dispute
        </a>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-content">
      <i class="fas fa-box-open"></i>
      <h3>No Orders Found</h3>
      <p>Your order history will appear here once you make purchases</p>
      <a href="{% url 'browse_products' %}" class="btn btn-primary">
        <i class="fas fa-shopping-basket"></i> Start Shopping
      </a>
    </div>
  </div>
  {% endif %}
</div>

<!-- Order Details Modal -->
<div
  class="modal fade"
  id="orderDetailsModal"
  tabindex="-1"
  aria-labelledby="orderDetailsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="orderDetailsContent"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Dispute Modal -->
<div class="modal fade" id="disputeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">File Dispute</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="disputeForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Are you sure you want to file a dispute for this order? This will prevent the automatic release of funds.
          </div>
          <div class="mb-3">
            <label for="disputeReason" class="form-label">Reason for Dispute</label>
            <textarea class="form-control" id="disputeReason" name="dispute_reason" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Submit Dispute</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function showOrderDetails(orderId) {
    // Fetch order details via AJAX
    fetch(`/order/${orderId}/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('orderDetailsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
      })
      .catch(error => {
        console.error('Error fetching order details:', error);
      });
  }

  function confirmOrder(orderId) {
    // Show confirmation dialog using SweetAlert2
    Swal.fire({
      title: 'Confirm Order Completion',
      text: 'Are you sure you want to confirm this order? This will initiate the 24-hour countdown for payment release.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2e7d32',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, confirm it!'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/order/${orderId}/confirm/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire(
              'Confirmed!',
              'Your order has been confirmed. Payment will be released after 24 hours.',
              'success'
            ).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire(
              'Error!',
              data.error || 'Something went wrong.',
              'error'
            );
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire(
            'Error!',
            'An error occurred while confirming the order.',
            'error'
          );
        });
      }
    });
  }

  // Countdown timer functionality
  function updateCountdown(timerId) {
    const timerElement = document.getElementById(timerId);
    if (!timerElement) return;

    const releaseTime = new Date(timerElement.dataset.releaseTime).getTime();
    const now = new Date().getTime();
    const timeLeft = releaseTime - now;

    if (timeLeft <= 0) {
      // Time's up - check if payment should be released
      fetch('/check-pending-releases/', {
        method: 'GET',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        }
      });
      return;
    }

    // Calculate hours, minutes, seconds
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    // Update the display
    const countdownValue = timerElement.querySelector('.countdown-value');
    countdownValue.textContent = `${hours}h ${minutes}m ${seconds}s`;

    // Add visual feedback when less than 1 hour remains
    if (hours < 1) {
      countdownValue.classList.add('expiring');
    } else {
      countdownValue.classList.remove('expiring');
    }
  }

  // Start countdown for all timers
  document.querySelectorAll('[id^="countdown-timer-"]').forEach(timer => {
    const timerId = timer.id;
    updateCountdown(timerId);
    setInterval(() => updateCountdown(timerId), 1000);
  });

  function showDisputeModal(orderId) {
    const modal = document.getElementById('disputeModal');
    const form = document.getElementById('disputeForm');
    form.action = `/order/${orderId}/dispute/`;
    new bootstrap.Modal(modal).show();
  }

  // Reorder functionality
  function reorderProduct(orderId, quantity) {
    // Show confirmation dialog using SweetAlert2
    Swal.fire({
      title: 'Confirm Reorder',
      text: `Are you sure you want to reorder ${quantity}kg of this product?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2e7d32',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, reorder it!'
    }).then((result) => {
      if (result.isConfirmed) {
        // Create a form element
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/reorder/${orderId}/`;

        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // Add quantity input
        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = 'quantity';
        quantityInput.value = quantity;
        form.appendChild(quantityInput);

        // Append form to document and submit
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

<style>
  .order-history-container {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .order-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }

  .order-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  .order-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
  }

  .order-meta {
    padding: 1rem;
    background: var(--accent-mint);
    border-bottom: 2px solid var(--secondary-green);
  }

  .order-id {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .order-id h3 {
    margin: 0;
    color: var(--primary-green);
    font-size: 1.2rem;
  }

  .order-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .order-status.processing {
    background: #fff3cd;
    color: #856404;
  }
  .order-status.completed {
    background: #d4edda;
    color: #155724;
  }
  .order-status.cancelled {
    background: #f8d7da;
    color: #721c24;
  }
  .order-status.refunded {
    background: #fff3cd;
    color: #856404;
  }

  .order-dates {
    display: flex;
    gap: 1rem;
    color: var(--dark-black);
    font-size: 0.8rem;
  }

  .order-products {
    padding: 1rem;
  }

  .products-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .products-header h4 {
    margin: 0;
    color: var(--primary-green);
    font-size: 1rem;
    font-weight: 600;
  }

  .total-amount {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--secondary-green);
  }

  .product-item {
    display: flex;
    gap: 1rem;
  }

  .product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .product-info {
    flex: 1;
  }

  .product-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .vendor-info, .product-location, .payment-info {
    font-size: 0.8rem;
    color: var(--dark-black);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .payment-status {
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .payment-status.pending {
    background: #fff3cd;
    color: #856404;
  }

  .payment-status.in-escrow {
    background: #cce5ff;
    color: #004085;
  }

  .payment-status.released {
    background: #d4edda;
    color: #155724;
  }

  .payment-status.refunded {
    background: #fff3cd;
    color: #856404;
  }

  .payment-status.waiting {
    background: #cff4fc;
    color: #087990;
  }

  .payment-status.disputed {
    background: #f8d7da;
    color: #721c24;
  }

  .payment-details {
    margin-top: 0.25rem;
    color: var(--dark-black);
  }

  .order-actions {
    padding: 1rem;
    border-top: 1px solid var(--light-gray);
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .btn-details {
    background: var(--light-gray);
    color: var(--dark-black);
    border: none;
  }

  .btn-payment {
    background: var(--primary-green);
    color: white;
  }

  .btn-repeat {
    background: var(--secondary-green);
    color: white;
  }

  .btn-dispute {
    background: #dc3545;
    color: white;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  .empty-content {
    max-width: 400px;
    margin: 0 auto;
  }

  .empty-content i {
    font-size: 4rem;
    color: var(--light-gray);
    margin-bottom: 1rem;
  }

  .empty-content h3 {
    margin-bottom: 0.5rem;
    color: var(--dark-black);
  }

  .empty-content p {
    color: var(--dark-black);
    margin-bottom: 1.5rem;
  }

  .btn-primary {
    background: var(--primary-green);
    color: white;
  }

  .btn-complete {
    background-color: #2e7d32;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-complete:hover {
    background-color: #1b5e20;
    transform: translateY(-2px);
  }
  
  .btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: not-allowed;
    opacity: 0.8;
  }
  
  .btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .btn-danger:hover {
    background-color: #c82333;
    transform: translateY(-2px);
  }

  .countdown-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
  }

  .countdown-timer {
    background: rgba(255, 255, 255, 0.9);
    padding: 0.5rem 1rem;
    border-radius: 5px;
    text-align: center;
    min-width: 200px;
  }

  .countdown-label {
    font-weight: 600;
    margin-right: 0.5rem;
    color: #495057;
  }

  .countdown-value {
    font-family: monospace;
    font-size: 1.1rem;
    color: #2e7d32;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  .countdown-value.expiring {
    color: #dc3545;
    animation: pulse 1s infinite;
  }
</style>
{% endblock %}
